#!/bin/bash

# Here, we test the test framework using the framework itself, hence the file's name. On its own,
# this would be a pretty poor test (a madman can easily prove to himself that he is sane), so it
# should be run in conjunction with `simple-test`.

[[ -n "${ENYX_REGTEST_DIR-}" ]] || ENYX_REGTEST_DIR=..

. "$ENYX_REGTEST_DIR"/run-tests.sh
. "$ENYX_REGTEST_DIR"/utils-extra.sh

[[ "$BASH_VERSION" == 4.[12].* ]] && {
    # Bash 4.{1,2} insist on printing "Terminated" messages on subshell exit in certain cases...
    # It's easier to filter these messages out here than trying to fix this silly display bug, for
    # old versions of bash no less.
    regtest_ref_diff() {
        local out_name=$1 ref=$regtest_refdir/$out_name out=$regtest_outdir/$out_name
        [[ -f "$out" ]] && {
            grep -v 'Terminated.*regtest_kill_children_on_exit' "$out" > "$out.tmp"
            mv "$out.tmp" "$out"
        }
        diff -qr "$ref" "$out" >/dev/null || {
            if [[ $? == 1 ]]; then return 1
            else return $regtest_ret_fatal
            fi
        }
    }
}

regtest_start

metasuite() {
##################################################################################################

regtest_dir=example

regtest meta-run-none \
    regtest_launch_in_sequence \
    -- regtest_expect_exit_status 1 \
       regtest_redirect_stdout_to {tmp.txt} \
       regtest_from_dir example \
       ./run-tests nosuchtest \
    -- test -f {tmp.txt} -a ! -s {tmp.txt} # (i.e. output is empty)

# Replace date and time in the output with placeholders.
replace_date_and_time() {
    local ms=[0-6][0-9]:[0-6][0-9]
    sed -e "s/[0-9]\{4\}-[0-1][0-9]-[0-3][0-9]-[0-2][0-9]:$ms/YYYY-MM-DD-hh:mm:ss/" \
        -e "s/$ms/mm:ss/"
}

metarun() {
    local out
    out=$(readlink -f "$1")
    shift
    (cd example && "$@") |& replace_date_and_time >> "$out"
}

run=(metarun {out.txt} ./run-tests --deterministic)

regtest meta-run-all \
    regtest_expect_exit_status 10 \
    "${run[@]}"

regtest meta-run-one-ok \
    "${run[@]}" ascii-hello

regtest meta-run-one-fail \
    regtest_expect_exit_status 10 \
    "${run[@]}" ascii-hello-bad-case-fail

regtest meta-print-all \
    "${run[@]}" --print

regtest meta-list-all \
    "${run[@]}" --list

regtest meta-list-glob \
    "${run[@]}" --list 'ascii-hello-color*' 'unicode*'

with_refdir() {
    regtest_env REGTEST_REFDIR="$(readlink -f "$1")" "${@:2}"
}

regtest meta-generate \
    with_refdir {tmp.refdir} \
    regtest_launch_in_sequence \
    -- mkdir {tmp.refdir} \
    -- regtest_expect_exit_status 10 \
       "${run[@]}" ascii-hello-color ascii-hello-color-bad-ref-fail \
    -- "${run[@]}" --generate ascii-hello-color ascii-hello-color-bad-ref-fail \
    -- "${run[@]}" ascii-hello-color ascii-hello-color-bad-ref-fail

regtest meta-forward \
    "${run[@]}" --forward ascii-hello

metarun_regtest_lines_only() {
    local out
    out=$(readlink -f "$1")
    shift
    (cd example && "$@") |& grep REGTEST | replace_date_and_time >> "$out"
}

# Note: We run the "unicode" tests after the "slow" tests to check that even after the "slow" test
# suite times out, the "unicode" test suite runs.
regtest meta-suite-timeout \
    regtest_env REGTEST_SUITE_TIMEOUT=.5s REGTEST_EXAMPLE_SUITE_FILES='slowgrep ascii unicode' \
    regtest_expect_exit_status 10 \
    metarun_regtest_lines_only {out.txt} \
    ./run-tests --deterministic 'slow-*' 'unicode-*'

# == `checksum-files` Tests

checksum_metarun() {
    local out dir=$2 links="run-tests $3" origdir
    out=$([[ "$1" == /* ]] && printf '%s' "$1" || printf '%s' "$PWD/$1")
    shift 3
    origdir=$PWD
    mkdir -p "$dir"
    (
        cd "$dir"
        trap 'rm $links && rm -rf out log' EXIT
        for l in $links; do
            ln -s "$origdir/example/$l" ./
        done
        export LC_ALL=C \
               REGTEST_EXAMPLE_EXTRA_SETUP='. "$ENYX_REGTEST_DIR"/checksum-files.sh' \
               REGTEST_EXAMPLE_SUITE_FILES='ascii misc'
        ENYX_REGTEST_DIR=$origdir/.. "$@" |& replace_date_and_time >> "$out"
    )
}

# Check that checksum is computed and saved.
regtest meta-checksum-file \
    checksum_metarun {out.txt} {out.dir} 'tests inputs refs' \
    ./run-tests ascii-hello-color

# Check that checksum is computed (and saved) when the output is a directory.
regtest meta-checksum-file-dir \
    checksum_metarun {out.txt} {out.dir} 'tests inputs refs' \
    ./run-tests misc-dir-output

# Check that both checksums are computed and saved.
regtest meta-checksum-file-both \
    checksum_metarun {out.txt} {out.dir} 'tests inputs refs' \
    ./run-tests --deterministic ascii-hello-color misc-dir-output

checksum_file={ref}/$regtest_prev_test.dir/reference-md5sums

checksum_metarun_with_existing_checksumfile() {
    local out=$1 dir=$2 checksum_file=$3
    shift 3
    mkdir "$dir" "$dir"/refs
    touch "$dir"/refs/{ascii-hello-color.txt,misc-dir-output.dir}
    [[ -n "$checksum_file" ]] && cp "$checksum_file" "$dir"
    checksum_metarun "$out" "$dir" 'tests inputs' "$@"
}

# Check that when checksums are already present (and they match), the reference files are ignored.
regtest meta-checksum-file-existing-checksum \
    checksum_metarun_with_existing_checksumfile {out.txt} {tmp.dir} "$checksum_file" \
    ./run-tests --deterministic ascii-hello-color misc-dir-output

# Check that an error is reported when no checksums can be found and the references files don't
# match.
regtest meta-checksum-file-bad-files-no-checksum \
    checksum_metarun_with_existing_checksumfile /dev/stdout {tmp.dir} '' \
    regtest_expect_exit_status 10 \
    ./run-tests --deterministic ascii-hello-color misc-dir-output

# Check that a bad checksum results in an error even if the output files are identical to their
# respective reference files.
regtest meta-checksum-file-bad-checksum-no-diff \
    regtest_launch_in_sequence \
    -- mkdir {tmp.dir} \
    -- cp "$checksum_file" {tmp.dir} \
    -- sed -i 's/[0-f][0-f][0-f][0-f] /0000 /' {tmp.dir}/reference-md5sums \
    -- checksum_metarun {out.txt} {tmp.dir} 'tests inputs refs' \
       regtest_expect_exit_status 10 \
       ./run-tests --deterministic ascii-hello-color misc-dir-output

##################################################################################################
}

regtest_on_exit 'regtest_finish'
regtest_run_suite metasuite metasuite
